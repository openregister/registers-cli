# Based on boilerplate from https://github.com/cloudfoundry/nginx-buildpack/tree/master/fixtures/mainline
worker_processes 1;
daemon off;

error_log stderr;
events { worker_connections 1024; }


http {
  # Content Negotiation
  map $http_accept $format {
    default json;
    text/csv csv;
    application/json json;
  }
  charset utf-8;
  log_format cloudfoundry 'NginxLog "$request" $status $body_bytes_sent';
  access_log /dev/stdout cloudfoundry;
  default_type application/json;
  include mime.types;
  sendfile on;

  tcp_nopush on;
  keepalive_timeout 30;
  port_in_redirect off; # Ensure that redirects don't include the internal container PORT - 8080

  server {
    listen {{port}};
    root public;
    # Open API at root path
    index openapi.json;
    absolute_redirect off;
    # Rewrite Rules
    # Syntax rewrite regex URL [flag];

    # Remove trailing slashes
    rewrite ^/(.*)/$ /$1 permanent;
    # Records content negotiation
    location @recordscontentnegotiation { 
      rewrite ^/records/(.+)$ /records/$1.$format break;
    }

    # Items content negotiation
    location @itemscontentnegotiation { 
      rewrite /items/(.+)$ /items/$1.$format break;
    }
    # Entries content negotiation
    location @entriescontentnegotiation { 
      rewrite /entries/(.+)$ /entries/$1.$format break;
    }

    # Records
    location /records {
      rewrite ^/records.csv /records/index.csv;
      rewrite ^/records.json /records/index.json;
      rewrite ^/records$ /records/index.$format break;
      try_files $uri @recordscontentnegotiation; 
    }

    
    # Entries
    location /entries {
      # Entry slices
      if ($arg_start) {
        rewrite ^/entries$ /entries/slices/$arg_start.$format break;
        rewrite ^/entries.csv /entries/slices/$arg_start.csv;
        rewrite ^/entries.json /entries/slices/$arg_start.json;
      }
      rewrite ^/entries$ /entries/index.$format break;
      rewrite ^/entries.csv /entries/index.csv;
      rewrite ^/entries.json /entries/index.json;
      try_files $uri @entriescontentnegotiation;
    }

    location /items {
      rewrite ^/items.csv /items/index.csv;
      rewrite ^/items.json /items/index.json;
      rewrite ^/items$ /items/index.$format break;
      try_files $uri @itemscontentnegotiation;   
    }

    location / {

      # Legacy
      rewrite ^/record/(.*)$ /records/$1 permanent;
      rewrite ^/entry/(.*)$ /entries/$1 permanent;
      rewrite ^/item/(.*)$ /items/$1 permanent;

      # Register
      rewrite ^/register$ /register.json break;

      # Archive
      rewrite ^/download-register /archive.zip;

      # RSF
      rewrite ^/download-rsf /commands/0.rsf;
      rewrite ^/commands /commands/0.rsf break;
      rewrite ^/download-rsf/(.*)$ /commands/$1.rsf;
    }
  }
}
